import React__default from 'react';
import { authenticatorTextUtil } from '@aws-amplify/ui';
import { Button } from '../../../primitives/Button/Button.mjs';
import { Flex } from '../../../primitives/Flex/Flex.mjs';
import { View } from '../../../primitives/View/View.mjs';
import { FederatedSignIn } from '../FederatedSignIn/FederatedSignIn.mjs';
import { useAuthenticator } from '@aws-amplify/ui-react-core';
import { useCustomComponents } from '../hooks/useCustomComponents/useCustomComponents.mjs';
import { useFormHandlers } from '../hooks/useFormHandlers/useFormHandlers.mjs';
import { RemoteErrorMessage } from '../shared/RemoteErrorMessage.mjs';
import { FormFields } from '../shared/FormFields.mjs';

const { getCreateAccountText, getCreatingAccountText, getCreateAccountWithEmailText, getCreateAccountWithPasswordText, getCreateAccountWithSmsText, getOrText, } = authenticatorTextUtil;
function SignUp() {
    const { hasValidationErrors, isPending, availableAuthMethods, preferredChallenge, selectedAuthMethod, } = useAuthenticator((context) => [
        context.hasValidationErrors,
        context.isPending,
        context.availableAuthMethods,
        context.preferredChallenge,
        context.selectedAuthMethod,
    ]);
    const { handleChange, handleBlur, handleSubmit } = useFormHandlers();
    const { components: { 
    // @ts-ignore
    SignUp: { Header = SignUp.Header, FormFields = SignUp.FormFields, Footer = SignUp.Footer, }, }, } = useCustomComponents();
    // Filter out WEB_AUTHN for sign-up (passkeys are sign-in only)
    const signUpMethods = availableAuthMethods?.filter((m) => m !== 'WEB_AUTHN');
    const hasMultipleMethods = signUpMethods && signUpMethods.length > 1;
    // Determine which method to show first
    const primaryMethod = preferredChallenge && preferredChallenge !== 'WEB_AUTHN'
        ? preferredChallenge
        : 'PASSWORD';
    // Other methods (excluding primary)
    const otherMethods = signUpMethods?.filter((m) => m !== primaryMethod) ?? [];
    // Determine if password should be shown
    const effectiveMethod = selectedAuthMethod ?? primaryMethod;
    const isPasswordless = effectiveMethod !== 'PASSWORD';
    const getButtonText = (method) => {
        switch (method) {
            case 'EMAIL_OTP':
                return getCreateAccountWithEmailText();
            case 'SMS_OTP':
                return getCreateAccountWithSmsText();
            case 'PASSWORD':
                return hasMultipleMethods
                    ? getCreateAccountWithPasswordText()
                    : getCreateAccountText();
            default:
                return getCreateAccountText();
        }
    };
    const handleMethodClick = (method) => (e) => {
        e.preventDefault();
        const form = e.target.closest('form');
        if (form) {
            // Get or create the hidden input
            if (!form.__authMethod) {
                const input = document.createElement('input');
                input.name = '__authMethod';
                form.appendChild(input);
            }
            // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access
            form.__authMethod.type = 'hidden';
            // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access
            form.__authMethod.value = method;
            form.requestSubmit();
        }
    };
    return (React__default.createElement(View, null,
        React__default.createElement(Header, null),
        React__default.createElement("form", { "data-amplify-form": "", "data-amplify-authenticator-signup": "", method: "post", onChange: handleChange, onSubmit: handleSubmit, onBlur: handleBlur },
            React__default.createElement(FederatedSignIn, null),
            React__default.createElement(Flex, { as: "fieldset", direction: "column", isDisabled: isPending },
                React__default.createElement(Flex, { direction: "column" },
                    React__default.createElement(FormFields, { includePassword: !isPasswordless }),
                    React__default.createElement(RemoteErrorMessage, null)),
                React__default.createElement(Button, { isDisabled: ((!hasMultipleMethods || otherMethods.length == 0) &&
                        hasValidationErrors) ||
                        isPending, isFullWidth: true, type: "submit", variation: "primary", isLoading: isPending, loadingText: getCreatingAccountText(), onClick: handleMethodClick(primaryMethod) }, getButtonText(primaryMethod)),
                hasMultipleMethods && otherMethods.length > 0 && (React__default.createElement(React__default.Fragment, null,
                    React__default.createElement(Flex, { justifyContent: "center", padding: "medium 0" }, getOrText()),
                    otherMethods.map((method) => (React__default.createElement(Button, { key: method, isDisabled: isPending, isFullWidth: true, type: "button", variation: "primary", onClick: handleMethodClick(method) }, getButtonText(method)))))),
                React__default.createElement(Footer, null)))));
}
SignUp.Header = function Header() {
    // @ts-ignore
    return null;
};
SignUp.FormFields = function FormFields$1() {
    return React__default.createElement(FormFields, null);
};
SignUp.Footer = function Footer() {
    // @ts-ignore
    return null;
};

export { SignUp };
