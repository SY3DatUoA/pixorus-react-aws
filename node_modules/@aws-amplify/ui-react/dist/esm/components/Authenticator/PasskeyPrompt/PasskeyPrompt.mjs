import React__default from 'react';
import { listWebAuthnCredentials, associateWebAuthnCredential } from 'aws-amplify/auth';
import { authenticatorTextUtil } from '@aws-amplify/ui';
import { Button } from '../../../primitives/Button/Button.mjs';
import { Flex } from '../../../primitives/Flex/Flex.mjs';
import { Heading } from '../../../primitives/Heading/Heading.mjs';
import { Text } from '../../../primitives/Text/Text.mjs';
import { View } from '../../../primitives/View/View.mjs';
import { useAuthenticator } from '@aws-amplify/ui-react-core';
import '../../../primitives/Icon/Icon.mjs';
import '../../../primitives/Icon/context/IconsContext.mjs';
import { IconCheckCircleFill } from '../../../primitives/Icon/icons/IconCheckCircleFill.mjs';
import { IconPasskey } from '../../../primitives/Icon/icons/IconPasskey.mjs';
import { RemoteErrorMessage } from '../shared/RemoteErrorMessage.mjs';
import { RouteContainer } from '../RouteContainer/RouteContainer.mjs';

const { getPasskeyPromptHeadingText, getPasskeyPromptDescriptionText, getCreatePasskeyText, getRegisteringText, getContinueWithoutPasskeyText, getPasskeyCreatedSuccessText, getPasskeyRegisteredText, getPasskeyRegistrationFailedText, getPasskeyLabelText, getExistingPasskeysText, getSetupAnotherPasskeyText, getContinueText, } = authenticatorTextUtil;
function PasskeyPrompt({ className, variation, }) {
    const [success, setSuccess] = React__default.useState(false);
    const [error, setError] = React__default.useState(null);
    const [isRegistering, setIsRegistering] = React__default.useState(false);
    const [credentials, setCredentials] = React__default.useState([]);
    const { submitForm, isPending } = useAuthenticator((context) => [
        context.submitForm,
        context.isPending,
    ]);
    const loadCredentials = React__default.useCallback(async () => {
        try {
            const result = await listWebAuthnCredentials();
            setCredentials(result.credentials || []);
        }
        catch {
            // Silently fail - credentials list is optional
        }
    }, []);
    React__default.useEffect(() => {
        if (success) {
            void loadCredentials();
        }
    }, [success, loadCredentials]);
    const handleSkip = React__default.useCallback(() => {
        submitForm({ type: 'SKIP' });
    }, [submitForm]);
    const handleContinue = React__default.useCallback(() => {
        submitForm({ type: 'SUBMIT' });
    }, [submitForm]);
    const handleRegister = React__default.useCallback(async () => {
        try {
            setError(null);
            setIsRegistering(true);
            await associateWebAuthnCredential();
            setSuccess(true);
        }
        catch (err) {
            const error = err;
            const errorName = error.name ?? '';
            const errorMessage = error.message ?? '';
            // If user canceled, skip silently without showing error
            if (errorName === 'PasskeyRegistrationCanceled' ||
                errorName === 'NotAllowedError' ||
                errorMessage.includes('canceled') ||
                errorMessage.includes('cancelled') ||
                errorMessage.includes('ceremony has been canceled') ||
                errorMessage.includes('not allowed')) {
                handleSkip();
                return;
            }
            // Show user-friendly error message
            setError(getPasskeyRegistrationFailedText());
        }
        finally {
            setIsRegistering(false);
        }
    }, [handleSkip]);
    if (success) {
        return (React__default.createElement(RouteContainer, { className: className, variation: variation },
            React__default.createElement(Flex, { direction: "column", padding: "large", "data-amplify-authenticator-passkeyprompt": "" },
                React__default.createElement(Flex, { direction: "column", gap: "xs" },
                    React__default.createElement(IconCheckCircleFill, { className: "amplify-authenticator__passkey-success-icon" }),
                    React__default.createElement(Heading, { level: 4 }, getPasskeyCreatedSuccessText()),
                    React__default.createElement(Text, null, getPasskeyRegisteredText())),
                credentials.length > 0 && (React__default.createElement(View, { marginTop: "large" },
                    React__default.createElement(Heading, { level: 5 }, getExistingPasskeysText()),
                    React__default.createElement(Flex, { direction: "column", gap: "xs", marginTop: "xs" }, credentials.map((cred, index) => (React__default.createElement(View, { key: cred.credentialId, className: "amplify-authenticator__passkey-credential-item" },
                        React__default.createElement(Text, { fontSize: "small" }, cred.friendlyCredentialName ??
                            `${getPasskeyLabelText()} ${index + 1}`))))))),
                React__default.createElement(Flex, { direction: "column", gap: "medium", marginTop: "large" },
                    React__default.createElement(Button, { onClick: () => {
                            setSuccess(false);
                            handleRegister();
                        }, variation: "link" }, getSetupAnotherPasskeyText()),
                    React__default.createElement(Button, { onClick: () => handleContinue(), variation: "primary", isFullWidth: true }, getContinueText())))));
    }
    const isButtonDisabled = isPending || isRegistering;
    return (React__default.createElement(RouteContainer, { className: className, variation: variation },
        React__default.createElement("form", { "data-amplify-form": "", "data-amplify-authenticator-passkeyprompt": "" },
            React__default.createElement(Flex, { direction: "column", gap: "medium" },
                React__default.createElement(Heading, { level: 4 }, getPasskeyPromptHeadingText()),
                React__default.createElement(Text, null, getPasskeyPromptDescriptionText()),
                React__default.createElement(Flex, { justifyContent: "center" },
                    React__default.createElement(IconPasskey, { className: "amplify-authenticator__passkey-icon" })),
                React__default.createElement(Flex, { direction: "column", gap: "medium" },
                    React__default.createElement(Button, { onClick: () => void handleRegister(), variation: "primary", isDisabled: isButtonDisabled, isLoading: isRegistering, loadingText: getRegisteringText() }, getCreatePasskeyText()),
                    React__default.createElement(Button, { onClick: handleSkip, variation: "link", isDisabled: isButtonDisabled }, getContinueWithoutPasskeyText()),
                    error && (React__default.createElement(Text, { className: "amplify-authenticator__passkey-error" }, error)),
                    React__default.createElement(RemoteErrorMessage, null))))));
}

export { PasskeyPrompt };
